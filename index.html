<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PumpWolf Dashboard â€” Live Tokens</title>
  <meta name="description" content="PumpWolf Dashboard â€” live token feed (via Moralis proxy)" />
  <style>
    :root{--bg:#030406;--card:#071018;--neon:#00f0ff;--muted:#9bb}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:radial-gradient(circle at 10% 10%,#02030a 0%,var(--bg) 60%);color:#dff}
    header{padding:14px 16px;display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#002,#013);display:flex;align-items:center;justify-content:center;font-weight:700}
    .layout{display:flex;gap:16px;padding:16px}
    .col-left{width:260px;min-width:220px}.col-main{flex:1}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.015));border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid rgba(0,240,255,0.04)}
    .btn{background:linear-gradient(90deg,var(--neon),#8a2be2);border:none;color:#001;padding:8px 12px;border-radius:10px;cursor:pointer}
    .tiny{font-size:0.9rem;color:var(--muted)}
    .token-list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
    .token{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(0,0,0,0.15);border:1px solid rgba(0,240,255,0.03)}
    pre.debug{background:#051018;padding:12px;border-radius:8px;color:#bfe;font-size:0.82rem;overflow:auto;max-height:220px}
    .pw-fallback{position:fixed;inset:12px;z-index:9999;display:none;background:linear-gradient(90deg,#081018,#021);padding:12px;border-radius:12px;border:1px solid rgba(0,240,255,0.06)}
  </style>
</head>
<body>
  <div id="pwFallback" class="pw-fallback" role="alert" aria-live="polite">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:12px;height:12px;border-radius:50%;background:#ff6b6b"></div>
      <div>
        <div style="font-weight:700;color:var(--neon)">Mode statis: server proxy tidak aktif</div>
        <div class="tiny">Untuk experience penuh (live data) buka versi Vercel.</div>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <a id="openVercel" class="btn" href="https://pumpwolf.vercel.app/" target="_blank" rel="noopener">Buka versi penuh</a>
      <button id="stayBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Tetap di sini</button>
      <span id="countdown" style="margin-left:8px;color:var(--muted)">â†ª otomatis pindah dalam 8s</span>
    </div>
  </div>

  <header>
    <div class="logo">PW</div>
    <div>
      <h1 style="margin:0;color:var(--neon)">PumpWolf Dashboard</h1>
      <div class="tiny">Live feed â€” via Moralis (proxy)</div>
    </div>
  </header>

  <div class="layout">
    <aside class="col-left">
      <div class="card">
        <div class="tiny">Connected API</div>
        <div id="api-status" style="color:var(--neon);margin-top:6px">Proxy: ready</div>
        <div class="tiny" style="margin-top:8px">Last update: <span id="last-update">â€”</span></div>
      </div>

      <div class="card">
        <div style="display:flex;gap:8px">
          <button id="refreshBtn" class="btn">Refresh</button>
          <button id="pauseBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Pause</button>
        </div>
      </div>

      <div class="card">
        <div class="tiny">Debug panel (fetch status & headers)</div>
        <pre id="debug" class="debug">(ready)</pre>
      </div>
    </aside>

    <main class="col-main">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="color:var(--neon)">Live Tokens</strong> <span class="tiny">â€” tokens that passed filters</span></div>
          <div class="tiny">Refresh: <span id="interval-label">60s</span></div>
        </div>
        <div id="tokenContainer" class="token-list" style="margin-top:12px"></div>
      </div>
    </main>
  </div>

<script>
/* CONFIG - ganti jika perlu */
const FEATURED_TOKEN_ADDRESS = "YOUR_TOKEN_ADDRESS"; // optional
const POLL_INTERVAL = 60000;
const MIN_LIQUIDITY = 5000;

/* Resolve proxy endpoint:
   - when served from Vercel domain -> use relative /api/proxy
   - otherwise (GitHub Pages) -> use absolute pumpwolf.vercel.app domain
*/
function resolveEndpoint(path){
  const isVercel = location.hostname.endsWith('vercel.app') || location.hostname === 'pumpwolf.vercel.app';
  if (isVercel) return `/api/proxy/${path.replace(/^\/+/, '')}`;
  return `https://pumpwolf.vercel.app/api/proxy/${path.replace(/^\/+/, '')}`;
}

const ENDPOINT = resolveEndpoint('token/mainnet/exchange/pumpfun/new?limit=100');
const FEATURE_PRICE_URL = (addr) => resolveEndpoint(`token/mainnet/${addr}/price`);

/* UI refs */
const apiStatusEl = document.getElementById('api-status');
const lastUpdateEl = document.getElementById('last-update');
const tokenContainer = document.getElementById('tokenContainer');
const debugEl = document.getElementById('debug');
const fallback = document.getElementById('pwFallback');
const openVercel = document.getElementById('openVercel');
const stayBtn = document.getElementById('stayBtn');
const countdownEl = document.getElementById('countdown');
let paused = false, pollHandle = null;

/* small debug helper */
function debugLog(...args){
  const t = new Date().toLocaleTimeString();
  debugEl.textContent = '[' + t + '] ' + args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ') + '\n' + debugEl.textContent;
}

/* fetch tokens using proxy */
async function fetchTokens(){
  apiStatusEl.textContent = 'Fetching...';
  try {
    debugLog('Starting fetch to', ENDPOINT);
    const res = await fetch(ENDPOINT, { headers: { 'accept': 'application/json' }});
    debugLog('Response status:', res.status, { ok: res.ok, headers: (() => { const o={}; for(const k of res.headers.keys()) o[k]=res.headers.get(k); return o; })() });
    if (!res.ok){
      const text = await res.text().catch(()=>'[no body]');
      apiStatusEl.textContent = `Proxy: error ${res.status}`;
      tokenContainer.innerHTML = `<div class="tiny">Proxy returned ${res.status} â€” cek debug</div>`;
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
      debugLog('Non-ok body:', text.slice(0,200));
      return;
    }

    const data = await res.json().catch(() => null);
    if (!data || !Array.isArray(data.result)){
      apiStatusEl.textContent = 'Proxy: malformed';
      tokenContainer.innerHTML = `<div class="tiny">Proxy returned unexpected payload â€” cek debug</div>`;
      debugLog('Payload parse failed or missing result:', data);
      return;
    }

    const items = data.result.filter(it => Number(it.liquidity||0) >= MIN_LIQUIDITY);
    tokenContainer.innerHTML = '';
    if (!items.length){
      tokenContainer.innerHTML = `<div class="tiny">No tokens passed liquidity filter (>= ${MIN_LIQUIDITY}).</div>`;
    } else {
      items.forEach(it => {
        const addr = it.tokenAddress || it.address || Math.random().toString(36).slice(2,8);
        const liq = Number(it.liquidity||0);
        const fdv = Number(it.fullyDilutedValuation||0);
        const created = it.createdAt ? new Date(it.createdAt).toLocaleTimeString() : 'â€”';
        const row = document.createElement('div');
        row.className = 'token';
        row.dataset.addr = addr;
        row.innerHTML = `<div><div><b style="color:var(--neon)">${(it.symbol||'?').toUpperCase()}</b> â€” ${it.name||'Unnamed'}</div><div class="tiny">ðŸ’§ $${isFinite(liq)?liq.toLocaleString():'â€”'} â€¢ FDV: $${isFinite(fdv)?fdv.toLocaleString():'â€”'}</div></div><div class="tiny">${created}</div>`;
        tokenContainer.appendChild(row);
      });
    }

    apiStatusEl.textContent = 'Proxy: OK';
    lastUpdateEl.textContent = new Date().toLocaleTimeString();
  } catch (err){
    console.error(err);
    apiStatusEl.textContent = 'Proxy: network error';
    tokenContainer.innerHTML = `<div class="tiny">Network error â€” cek console/debug</div>`;
    debugLog('Fetch exception:', err && (err.message || err));
  }
}

document.getElementById('refreshBtn').addEventListener('click', fetchTokens);
document.getElementById('pauseBtn').addEventListener('click', function(){
  paused = !paused;
  this.textContent = paused ? 'Resume' : 'Pause';
  if (paused) { if (pollHandle) clearInterval(pollHandle); pollHandle = null; } else startPolling();
});

function startPolling(){ if (pollHandle) clearInterval(pollHandle); pollHandle = setInterval(fetchTokens, POLL_INTERVAL); }
startPolling(); fetchTokens();

/* Fallback/probe when loaded from GitHub Pages (or other non-vercel host) */
(async function tryProbe(){
  const isVercel = location.hostname.endsWith('vercel.app') || location.hostname === 'pumpwolf.vercel.app';
  if (isVercel){
    // hide fallback if present
    if (fallback) fallback.style.display = 'none';
    return;
  }

  function probe(url, timeout=3500){
    return new Promise(resolve => {
      let done=false;
      const t = setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, timeout);
      fetch(url, { method:'GET', mode:'cors' }).then(r => {
        if(done) return;
        done=true; clearTimeout(t); resolve(!!(r && r.ok));
      }).catch(()=>{ if(!done){ done=true; clearTimeout(t); resolve(false); } });
    });
  }

  const vercelProbe = resolveEndpoint('token/mainnet/exchange/pumpfun/new?limit=1');
  const ok = await probe(vercelProbe, 3500);
  debugLog('Probe ok:', ok, vercelProbe);
  if (ok){
    if (fallback) fallback.style.display = 'none';
    return;
  }

  // show fallback banner + countdown
  if (fallback) fallback.style.display = 'block';
  let count = 8;
  countdownEl.textContent = `â†ª otomatis pindah dalam ${count}s`;
  const timer = setInterval(()=> {
    count--;
    countdownEl.textContent = `â†ª otomatis pindah dalam ${count}s`;
    if (count <= 0) { clearInterval(timer); window.location.href = 'https://pumpwolf.vercel.app/'; }
  }, 1000);

  stayBtn.addEventListener('click', ()=>{
    clearInterval(timer);
    countdownEl.textContent = 'Redirect dibatalkan â€” tetap di halaman ini';
    stayBtn.disabled = true;
  });
})();

</script>
</body>
</html>
