<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PumpWolf Dashboard</title>
  <meta name="description" content="Track Solana gems live." />
  <meta property="og:image" content="/assets/pumpwolf_banner.jpg" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg: #030406; --neon: #00f0ff; --muted: #9bb; }
    body { font-family: Inter, sans-serif; background: linear-gradient(135deg, #02030a, var(--bg)); color: #dff; margin: 0; }
    header { padding: 12px; display: flex; align-items: center; gap: 12px; background: rgba(7, 16, 24, 0.9); }
    .logo { width: 50px; height: 50px; border-radius: 8px; object-fit: contain; }
    .banner { width: 100%; height: 100px; background: url('/assets/pumpwolf_banner.jpg') no-repeat center; background-size: cover; margin-bottom: 12px; }
    .card { padding: 12px; background: #071018; border-radius: 8px; margin: 8px 0; cursor: pointer; transition: transform 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 240, 255, 0.1); }
    .token-list { max-height: 65vh; overflow: auto; }
    .tiny { font-size: 0.8rem; color: var(--muted); }
    .btn { background: var(--neon); padding: 6px 10px; border: none; border-radius: 6px; color: #001; }
    .debug { display: none; font-family: monospace; font-size: 12px; color: #c8fff6; max-height: 200px; overflow: auto; }
    .debug.visible { display: block; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); align-items: center; justify-content: center; z-index: 1000; }
    .modal.open { display: flex; }
    .modal-content { background: #071018; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90vh; overflow: auto; color: #dff; }
    @media (max-width: 600px) { .card { margin: 4px 0; } .modal-content { padding: 10px; } }
  </style>
</head>
<body>
  <div class="banner"></div>
  <header>
    <img class="logo" src="/assets/wolf_logo.png" alt="PW" onerror="this.src='/assets/placeholder.png';" />
    <h1>PumpWolf</h1>
  </header>
  <div class="card">
    <div>API Status: <span id="api-status">Loading...</span></div>
    <div class="tiny">Last Update: <span id="last-update">â€”</span></div>
  </div>
  <div class="card">
    <div id="tokenContainer" class="token-list"><div class="tiny">Loading...</div></div>
    <div id="debugContainer" class="card">
      <button id="toggleDebug" class="btn">Toggle Debug</button>
      <div id="debugPanel" class="debug"></div>
    </div>
  </div>
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title"></h2>
      <div id="modal-details"></div>
      <button id="close-modal" class="btn" style="margin-top: 10px;">Close</button>
    </div>
  </div>
  <script>
    const MORALIS_BASE = "https://solana-gateway.moralis.io";
    const TOKEN_LIST_ENDPOINT = `${MORALIS_BASE}/token/mainnet/exchange/pumpfun/new?limit=10`;
    const apiStatusEl = document.getElementById('api-status');
    const lastUpdateEl = document.getElementById('last-update');
    const tokenContainer = document.getElementById('tokenContainer');
    const debugPanel = document.getElementById('debugPanel');
    const toggleDebug = document.getElementById('toggleDebug');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDetails = document.getElementById('modal-details');
    const closeModal = document.getElementById('close-modal');
    window.tokenMap = {};

    function debugLog(...args) {
      const t = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${t}] ${args.join(' ')}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    async function fetchJson(url) {
      try {
        debugLog(`Fetching ${url}`);
        const res = await fetch(url, {
          headers: { 'X-API-Key': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImE5ZmRkYjBkLTAyYWQtNGQ4OC1hYmIyLTRhMzYxZTZhNmZmNCIsIm9yZ0lkIjoiNDQ1NjQ1IiwidXNlcklkIjoiNDU4NTE0IiwidHlwZUlkIjoiOWQ3YzFmOTEtN2VkOS00ZDQ1LTg1ODItYWIyM2M5Nzg2YWRmIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NDY1ODE1MDksImV4cCI6NDkwMjM0MTUwOX0.WJgUJRDahW8g_WGSg-1lDIgUi4oaGf_dH9222tOFYXE', 'accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        debugLog("Error:", err.message);
        return null;
      }
    }

    async function fetchTokens() {
      const data = await fetchJson(TOKEN_LIST_ENDPOINT);
      if (!data?.result?.length) {
        debugLog("No data, using dummy");
        renderTokens([{ name: "Dummy1", symbol: "D1", liquidity: 10000, fullyDilutedValuation: 5000, createdAt: new Date().toISOString() },
                      { name: "Dummy2", symbol: "D2", liquidity: 12000, fullyDilutedValuation: 6000, createdAt: new Date().toISOString() }]);
        return;
      }
      const tokens = data.result.map(item => ({
        tokenAddress: item.token_address,
        name: item.name || `Token ${item.token_address.slice(0, 6)}`,
        symbol: item.symbol || '?',
        liquidity: Number(item.liquidity) || 0,
        fullyDilutedValuation: Number(item.fullyDilutedValuation) || 0,
        createdAt: item.createdAt || new Date().toISOString(),
        logo: item.logo || "/assets/placeholder.png"
      })).filter(t => t.liquidity >= 5000 && t.fullyDilutedValuation <= 15000);
      renderTokens(tokens);
      apiStatusEl.textContent = 'Moralis: OK';
    }

    function renderTokens(tokens) {
      tokenContainer.innerHTML = tokens.map(t => {
        window.tokenMap[t.tokenAddress] = t;
        return `
          <div class="card token" data-addr="${t.tokenAddress}">
            <div><b style="color: var(--neon)">${t.symbol}</b> â€” ${t.name}</div>
            <div class="tiny">ðŸ’§ $${t.liquidity.toLocaleString()} â€¢ ðŸ§® $${t.fullyDilutedValuation.toLocaleString()}</div>
          </div>
        `;
      }).join('') || '<div class="tiny">No tokens</div>';
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
      debugLog(`Rendered ${tokens.length} tokens`);
    }

    function showModal(token) {
      modalTitle.textContent = `${token.symbol} â€” ${token.name}`;
      modalDetails.innerHTML = `
        <div class="tiny">Address: ${token.tokenAddress.slice(0, 6)}...</div>
        <div class="tiny">Liquidity: $${token.liquidity.toLocaleString()}</div>
        <div class="tiny">FDV: $${token.fullyDilutedValuation.toLocaleString()}</div>
        <div class="tiny">Created: ${new Date(token.createdAt).toLocaleString()}</div>
      `;
      modal.classList.add('open');
    }

    tokenContainer.addEventListener('click', (e) => {
      const tokenEl = e.target.closest('.token');
      if (tokenEl) {
        const addr = tokenEl.dataset.addr;
        const token = window.tokenMap[addr];
        if (token) {
          debugLog(`Clicked token: ${addr}`);
          showModal(token);
        }
      }
    });

    closeModal.addEventListener('click', () => modal.classList.remove('open'));
    modal.addEventListener('click', (e) => e.target === modal && modal.classList.remove('open'));
    toggleDebug.addEventListener('click', () => debugPanel.classList.toggle('visible'));
    setInterval(fetchTokens, 60000);
    fetchTokens();
  </script>
</body>
</html>
